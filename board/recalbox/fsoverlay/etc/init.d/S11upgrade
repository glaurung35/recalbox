#!/bin/bash

if test "$1" != "start"
then
  exit 0
fi

UPDATEARCH=`cat /recalbox/recalbox.arch`
UPDATEFILE="recalbox-${UPDATEARCH}.img.xz"

if test -e "/boot/update/${UPDATEFILE}"; then
  killall S06splash
  dd if=/dev/zero of=/dev/fb0 > /dev/null 2>&1
  fbv -f -i /recalbox/system/resources/offline-install-0.jpg &
  mount -o remount,rw /boot
  mv /boot/update/${UPDATEFILE} /recalbox/share/system/upgrade/
  mount -o remount,ro /boot
  ( exec /recalbox/scripts/upgrade/recalbox-squashfs-upgrade.sh )
  exit 0
fi
