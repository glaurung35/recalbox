#!/bin/bash

if test "$1" != "start"
then
  exit 0
fi

ARCH=$(cat /recalbox/recalbox.arch)
if [ "$ARCH" = "odroidxu4" ]; then
  # HACK: for odroidxu4, the ARCH is xu4
  ARCH=xu4
fi

file="/boot/update/recalbox-$ARCH.img.xz"
if [[ -f $file ]]; then
  UPDATEFILE=${file}
  UPDATEFILE_UNCOMPRESSED=${file::-3}
  recallog -f upgrade.log "upgrade found! moving ${UPDATEFILE} to SHARE as $(basename "${UPDATEFILE_UNCOMPRESSED}")"
  fbv2 -k -i /recalbox/system/resources/offline-install-0.jpg
  unxz -c "${UPDATEFILE}" >"/recalbox/share/system/upgrade/$(basename "$UPDATEFILE_UNCOMPRESSED")"
  mount -o remount,rw /boot
  rm "${UPDATEFILE}"
  mount -o remount,ro /boot
  ( exec /recalbox/scripts/upgrade/recalbox-squashfs-upgrade.sh )
  exit 0
fi
