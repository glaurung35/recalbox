From 989ce62fb83abbf1a9a72b29b47ec30eb4a65bee Mon Sep 17 00:00:00 2001
From: David Barbion <davidb@230ruedubac.fr>
Date: Mon, 29 Jul 2024 20:54:45 +0200
Subject: [PATCH] Clean up pidwait and pidfd_open logic

---
 configure.ac | 26 ++++++++++----------------
 pgrep.c      | 11 ++++++++++-
 2 files changed, 20 insertions(+), 17 deletions(-)

diff --git a/configure.ac b/configure.ac
index 688271e9..1fff5d6c 100644
--- a/configure.ac
+++ b/configure.ac
@@ -132,21 +132,6 @@ AC_TRY_COMPILE([#include <errno.h>],
 		AC_MSG_RESULT(yes),
 		AC_MSG_RESULT(no))
 
-AC_CHECK_FUNCS([pidfd_open], [enable_pwait=yes], [
-  AC_MSG_CHECKING([for __NR_pidfd_open])
-  AC_COMPILE_IFELSE([AC_LANG_SOURCE([
-#include <sys/syscall.h>
-#ifndef __NR_pidfd_open
-#error __NR_pidfd_open not defined
-#endif
-    ])], [enable_pwait=yes], [enable_pwait=no])
-  AC_MSG_RESULT([$enable_pwait])
-])
-if test "$enable_pwait" = yes; then
-  AC_DEFINE([ENABLE_PWAIT], [1], [Enable pwait])
-fi
-AM_CONDITIONAL([BUILD_PWAIT], [test x$enable_pwait = xyes])
-
 dnl watch8bit must be before the AC_ARG_WITH set as it sets up ncurses
 AC_SUBST([WITH_WATCH8BIT])
 AC_ARG_ENABLE([watch8bit],
@@ -240,6 +225,15 @@ AC_ARG_ENABLE([w],
 )
 AM_CONDITIONAL(BUILD_W, test "x$enable_w" = xyes)
 
+AC_ARG_ENABLE([pidwait],
+  AS_HELP_STRING([--disable-pidwait], [do not build pidwait]),
+  [], [enable_pidwait=yes]
+)
+if test "$enable_pidwait" = "yes"; then
+  AC_DEFINE([ENABLE_PWAIT], [1], [Enable pidwait])
+fi
+AM_CONDITIONAL(BUILD_PWAIT, test "x$enable_pidwait" = xyes)
+
 AM_CONDITIONAL(LINUX, test "x$host_os" = xlinux-gnu)
 AM_CONDITIONAL(CYGWIN, test "x$host_os" = xcygwin)
 
@@ -325,7 +319,7 @@ then
 fi
 AC_SUBST(DEJAGNU)
 
-AC_CHECK_FUNCS([__fpending alarm atexit dup2 gethostname getpagesize gettimeofday iswprint memchr memmove memset mkdir nl_langinfo putenv regcomp rpmatch select setlocale strcasecmp strchr strcspn strdup strerror strncasecmp strndup strpbrk strrchr strspn strstr strtol strtoul strtoull strverscmp utmpname wcwidth])
+AC_CHECK_FUNCS([__fpending alarm atexit dup2 gethostname getpagesize gettimeofday iswprint memchr memmove memset mkdir nl_langinfo pidfd_open putenv regcomp rpmatch select setlocale strcasecmp strchr strcspn strdup strerror strncasecmp strndup strpbrk strrchr strspn strstr strtol strtoul strtoull strverscmp utmpname wcwidth])
 
 AC_CONFIG_FILES([Makefile
                  include/Makefile
diff --git a/pgrep.c b/pgrep.c
index faa371c5..23abbaca 100644
--- a/pgrep.c
+++ b/pgrep.c
@@ -38,10 +38,14 @@
 #include <stdbool.h>
 #include <time.h>
 
-#if defined(ENABLE_PWAIT)
+#ifdef ENABLE_PWAIT
 #include <sys/epoll.h>
+#ifdef HAVE_PIDFD_OPEN
+#include <sys/pidfd.h>
+#else
 #include <sys/syscall.h>
 #endif
+#endif
 
 /* EXIT_SUCCESS is 0 */
 /* EXIT_FAILURE is 1 */
@@ -743,6 +747,11 @@ static int signal_option(int *argc, char **argv)
 }
 
 #if defined(ENABLE_PWAIT) && !defined(HAVE_PIDFD_OPEN)
+
+#ifndef __NR_pidfd_open
+#define __NR_pidfd_open 434 /* from linux/include/uapi/asm-generic/unistd.h */
+#endif
+
 static int pidfd_open (pid_t pid, unsigned int flags)
 {
 	return syscall(__NR_pidfd_open, pid, flags);
-- 
2.45.2

