#!/bin/bash

if test "$1" == "start" ; then
    # Scart DAC
    # Managing DAC for CRT (vga666, rgb-pi)
    CONFIG_LINE=$(grep -m 1 -e "^system.crt=.*" /recalbox/share/system/recalbox.conf)
    DAC=${CONFIG##*=}
    CRT_CONFIG_FILE="/boot/recalbox-crt-config.txt"
    CRT_TIMING_FILE="/boot/timings.txt"
    if [[ "${DAC}" == "vga666" || "${DAC}" == "rgbpi" ]];then
        # Assuming that it is already configured if /boot/recalbox-crt-config.txt is present
        if ! -f /boot/recalbox-crt-config.txt; then
            source /recalbox/scripts/recalbox-utils.sh
            recallog "[RECALBOX-CRT] Processing ${DAC} configuration."
            mount -o remount,rw /boot
            cp "/boot/crt-config/${DAC}-config.txt" "${CRT_CONFIG_FILE}"
            cp "/boot/crt-config/vga666-timings.txt" "${CRT_TIMING_FILE}"
            mount -o remount,ro /boot
            reboot
        fi
    elif [[ "${DAC}" == "" ]]; then
        if [[ -f "${CRT_CONFIG_FILE}" ]]; then
            # We should clean
            source /recalbox/scripts/recalbox-utils.sh
            recallog "[RECALBOX-CRT] Uninstalling CRT configuration."
            mount -o remount,rw /boot
            rm -rf "${CRT_CONFIG_FILE}" "${CRT_TIMING_FILE}"
            mount -o remount,ro /boot
            reboot
        fi
    else
        # Unsupported
        source /recalbox/scripts/recalbox-utils.sh
        recallog "[RECALBOX-CRT] Unable to process ${DAC} configuration. Not supported yet."
    fi
fi