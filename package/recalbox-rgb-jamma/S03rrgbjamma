#!/bin/bash

if test "$1" == "start"; then
  source /recalbox/scripts/recalbox-utils.sh
  # RRGBD or RRGBJ is already present if CRT is loaded
  if ! isCRTLoaded; then
    adapter=""
    mount -o remount,rw /
    mkdir -p /config
    mount -o remount,ro /
    mount -t configfs none /config
    # Detect production recalbox rgb jamma
    modprobe i2c-dev
    dtoverlay i2c1
    if i2cdetect -y 1 36 37 | grep -q "20:             24 25"; then
      adapter="recalboxrgbjamma-v2"
    elif i2cdetect -y 1 36 39 | grep -q "20:             24 25 -- 27"; then
      adapter="recalboxrgbjamma-v3"
    elif i2cdetect -y 1 36 39 | grep -q "20:             24 25 26 27"; then
      adapter="recalboxrgbjamma"
    fi
    dtoverlay -r i2c1
    rmmod i2c-dev
    umount /config

    if ["${adapter}" != ""]; then
      mount -o remount,rw /boot
      CONFIG="/boot/crt/recalbox-crt-options.cfg"
      CRT_DAC_FILE="/boot/crt/recalbox-crt-config.txt"
      echo "S03rrgbdjamma CRT Recalbox RGB Jamma Detected (${adapter})!" >> /boot/hardware.log
      if ! grep "dtoverlay=${adapter}" "${CRT_DAC_FILE}"; then
        if [ "$(getArchName)" == "rpi5_64" ]; then
          echo "dtoverlay=${adapter}-pi5" > "${CRT_DAC_FILE}"
        else
          echo "dtoverlay=${adapter}" > "${CRT_DAC_FILE}"
        fi
        if grep -q "adapter.type = .\+" "${CONFIG}";then
            sed -i "s/adapter.type = .+/adapter.type = ${adapter}/g" "${CONFIG}"
        else
            echo -e "\nadapter.type = ${adapter}" >> "${CONFIG}"
        fi
        echo "S03rrgbdjamma CRT Reboot after install of ${adapter}" >> /boot/hardware.log
        reboot
      fi
      mount -o ro,remount /boot
    fi
  fi
fi
